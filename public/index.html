<!doctype html>
<html lang="lv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rādījumu iesniegšana</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --text:#111827; --muted:#6b7280;
      --line:#e5e7eb; --btn:#0f5b7a; --btn2:#0b4a64;
      --danger:#b91c1c; --dangerBg:#fee2e2; --ok:#065f46; --okBg:#d1fae5;
    }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text);}
    .wrap{max-width:900px;margin:24px auto;padding:0 12px;}
    .card{background:var(--card); border:1px solid var(--line); border-radius:14px; padding:18px 18px 22px;}
    h1{margin:0 0 12px; font-size:22px;}
    .banner{border-radius:10px; padding:10px 12px; margin:10px 0 16px; font-size:14px;}
    .banner.danger{background:#fff1f2; border:1px solid #fecdd3; color:#9f1239;}
    .banner.info{background:#eef2ff; border:1px solid #c7d2fe; color:#3730a3;}

    .sectionTitle{margin:18px 0 8px; font-weight:700; font-size:14px;}
    label{display:block; font-size:13px; color:var(--muted); margin:10px 0 6px;}

    /* 8-digit boxes (narrow) */
    .digits{display:flex; gap:6px; align-items:center; flex-wrap:wrap;}
    .digit{
      width:40px;
      height:46px;
      text-align:center;
      font-size:18px;
      border:1px solid var(--line);
      border-radius:10px;
      outline:none;
      box-sizing:border-box;
    }
    .digit:focus{border-color:#93c5fd; box-shadow:0 0 0 3px rgba(147,197,253,.35);}

    input[type="text"]{
      width:100%; box-sizing:border-box; border:1px solid var(--line);
      border-radius:10px; padding:12px 12px; font-size:16px; outline:none;
    }
    input[type="text"]:focus{border-color:#93c5fd; box-shadow:0 0 0 3px rgba(147,197,253,.35);}

    .addrBlock{border:1px solid var(--line); border-radius:12px; padding:12px; margin-top:10px;}
    .addrHeader{display:flex; justify-content:space-between; align-items:center; gap:10px;}
    .addrHeader .title{font-weight:700;}

    .btn{background:var(--btn); color:#fff; border:none; padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:700;}
    .btn:hover{background:var(--btn2);}
    .btnLite{background:#fff; border:1px solid var(--line); color:#111827;}
    .btnLite:hover{background:#f3f4f6;}
    .btnDanger{background:#fff; border:1px solid #fca5a5; color:#b91c1c;}
    .btnDanger:hover{background:#fee2e2;}
    .btnDisabled{opacity:.45; cursor:not-allowed;}

    .meterRow{display:flex; gap:12px; flex-wrap:wrap; margin-top:10px; align-items:flex-end;}
    .meterRow .col{flex:1 1 220px;}
    .xBtn{
      width:44px; height:44px; border-radius:10px;
      border:1px solid #fca5a5; background:#fff; color:#b91c1c;
      font-weight:900; cursor:pointer;
    }
    .xBtn:hover{background:#fee2e2;}

    .submit{width:100%; padding:14px 16px; border-radius:12px; font-size:16px; margin-top:16px;}

    .msg{margin-top:12px; border-radius:10px; padding:10px 12px; font-size:14px;}
    .msg.err{background:var(--dangerBg); color:var(--danger); border:1px solid #fecaca;}
    .msg.ok{background:var(--okBg); color:var(--ok); border:1px solid #a7f3d0;}

    /* dropdown */
    .dropdown{position:relative;}
    .dropList{
      position:absolute; z-index:50; top:100%; left:0; right:0;
      background:#fff; border:1px solid var(--line); border-radius:12px;
      max-height:260px; overflow:auto; margin-top:6px; box-shadow:0 10px 30px rgba(0,0,0,.08);
      display:none;
    }
    .dropItem{padding:10px 12px; cursor:pointer; border-bottom:1px solid #f3f4f6;}
    .dropItem:last-child{border-bottom:none;}
    .dropItem:hover{background:#f3f4f6;}

    /* honeypot */
    .hp{position:absolute; left:-10000px; top:auto; width:1px; height:1px; overflow:hidden;}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Rādījumu iesniegšana</h1>

      <div id="banner" class="banner info" style="display:none"></div>

      <div class="sectionTitle">Abonenta informācija</div>

      <label>Abonenta kods (8 cipari)</label>
      <div id="code8" class="digits"></div>

      <div class="sectionTitle">Adreses un skaitītāji</div>
      <div id="addresses"></div>

      <div style="margin-top:12px;">
        <button class="btn btnLite" type="button" id="addAddressBtn">+ Pievienot adresi</button>
      </div>

      <button class="btn submit" type="button" id="submitBtn">IESNIEGT</button>

      <div id="msg" class="msg err" style="display:none"></div>

      <input class="hp" type="text" id="website" name="website" autocomplete="off" tabindex="-1" />
    </div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const code8Wrap = $('code8');
  const msg = $('msg');
  const banner = $('banner');

  let windowInfo = null;

  // ---------- 8 DIGIT INPUTS ----------
  function createDigitInputs(container, count) {
    container.innerHTML = '';
    const inputs = [];
    for (let i = 0; i < count; i++) {
      const inp = document.createElement('input');
      inp.type = 'text';
      inp.inputMode = 'numeric';
      inp.maxLength = 1;
      inp.className = 'digit';
      inp.autocomplete = 'off';

      inp.addEventListener('input', () => {
        inp.value = (inp.value || '').replace(/\D/g, '').slice(0, 1);
        if (inp.value && i < count - 1) inputs[i + 1].focus();
      });

      inp.addEventListener('keydown', (e) => {
        if (e.key === 'Backspace' && !inp.value && i > 0) inputs[i - 1].focus();
        if (e.key === 'ArrowLeft' && i > 0) inputs[i - 1].focus();
        if (e.key === 'ArrowRight' && i < count - 1) inputs[i + 1].focus();
      });

      inputs.push(inp);
      container.appendChild(inp);
    }
    return inputs;
  }

  const code8Inputs = createDigitInputs(code8Wrap, 8);
  code8Inputs[0].focus();

  function getSubscriberCode() {
    return code8Inputs.map(i => i.value || '').join('');
  }

  // ---------- UI HELPERS ----------
  function showMessage(text, isOk=false) {
    msg.style.display = 'block';
    msg.className = 'msg ' + (isOk ? 'ok' : 'err');
    msg.textContent = text;
  }
  function clearMessage() {
    msg.style.display = 'none';
    msg.textContent = '';
  }

  function debounce(fn, ms) {
    let t = null;
    return (...args) => {
      clearTimeout(t);
      t = setTimeout(() => fn(...args), ms);
    };
  }

  async function fetchAddresses(q) {
    const url = '/api/addresses?q=' + encodeURIComponent(q);
    const r = await fetch(url, { headers: { 'Accept': 'application/json' } });
    const data = await r.json();
    const arr = data.items || data.results || [];
    return Array.isArray(arr) ? arr : [];
  }

  function createDropdown(input) {
    const wrap = document.createElement('div');
    wrap.className = 'dropdown';
    input.parentNode.insertBefore(wrap, input);
    wrap.appendChild(input);

    const list = document.createElement('div');
    list.className = 'dropList';
    wrap.appendChild(list);

    function hide() { list.style.display = 'none'; list.innerHTML = ''; }
    function show(items) {
      list.innerHTML = '';
      if (!items.length) return hide();
      for (const it of items) {
        const div = document.createElement('div');
        div.className = 'dropItem';
        div.textContent = it;
        div.addEventListener('mousedown', (e) => {
          e.preventDefault();
          input.value = it;
          hide();
        });
        list.appendChild(div);
      }
      list.style.display = 'block';
    }

    const doQuery = debounce(async () => {
      const q = input.value.trim();
      if (q.length < 1) return hide();
      try {
        const items = await fetchAddresses(q);
        show(items);
      } catch (e) {
        hide();
      }
    }, 200);

    input.addEventListener('input', () => doQuery());
    input.addEventListener('focus', () => doQuery());
    input.addEventListener('blur', () => setTimeout(hide, 120));

    return { show, hide };
  }

  function newMeterRow(onRemove, isFirstRow) {
    const row = document.createElement('div');
    row.className = 'meterRow';

    const col1 = document.createElement('div');
    col1.className = 'col';
    const col2 = document.createElement('div');
    col2.className = 'col';

    const l1 = document.createElement('label'); l1.textContent = 'Skaitītāja Nr';
    const meterNo = document.createElement('input');
    meterNo.type = 'text';

    const l2 = document.createElement('label'); l2.textContent = 'Rādījums';
    const reading = document.createElement('input');
    reading.type = 'text';

    col1.appendChild(l1); col1.appendChild(meterNo);
    col2.appendChild(l2); col2.appendChild(reading);

    row.appendChild(col1);
    row.appendChild(col2);

    // Remove button ONLY for non-first rows
    if (!isFirstRow) {
      const x = document.createElement('button');
      x.type = 'button';
      x.className = 'xBtn';
      x.textContent = '×';
      x.title = 'Dzēst skaitītāju';
      x.addEventListener('click', () => onRemove(row));
      row.appendChild(x);
    }

    row._meterNo = meterNo;
    row._reading = reading;

    return row;
  }

  function newAddressBlock(index, isFirstAddress) {
    const block = document.createElement('div');
    block.className = 'addrBlock';

    const header = document.createElement('div');
    header.className = 'addrHeader';

    const title = document.createElement('div');
    title.className = 'title';
    title.textContent = 'Adrese ' + (index + 1);

    const delBtn = document.createElement('button');
    delBtn.type = 'button';
    delBtn.className = 'btn btnDanger';
    delBtn.textContent = 'Dzēst adresi';

    // First address cannot be deleted
    if (isFirstAddress) {
      delBtn.classList.add('btnDisabled');
      delBtn.disabled = true;
    }

    header.appendChild(title);
    header.appendChild(delBtn);

    const addrLabel = document.createElement('label');
    addrLabel.textContent = 'Adrese';

    const addrInput = document.createElement('input');
    addrInput.type = 'text';
    addrInput.placeholder = ''; // no grey hint

    const addrWrap = document.createElement('div');
    addrWrap.appendChild(addrInput);

    block.appendChild(header);
    block.appendChild(addrLabel);
    block.appendChild(addrWrap);

    createDropdown(addrInput);

    const metersHolder = document.createElement('div');

    function removeMeterRow(row) {
      metersHolder.removeChild(row);
    }

    // First row cannot be deleted (no X)
    metersHolder.appendChild(newMeterRow(removeMeterRow, true));

    const addMeterBtn = document.createElement('button');
    addMeterBtn.type = 'button';
    addMeterBtn.className = 'btn btnLite';
    addMeterBtn.textContent = '+ Pievienot skaitītāju';
    addMeterBtn.style.marginTop = '10px';
    addMeterBtn.addEventListener('click', () => {
      metersHolder.appendChild(newMeterRow(removeMeterRow, false));
    });

    block.appendChild(metersHolder);
    block.appendChild(addMeterBtn);

    block._addrInput = addrInput;
    block._metersHolder = metersHolder;

    delBtn.addEventListener('click', () => {
      if (isFirstAddress) return;
      block.parentNode.removeChild(block);
      renumberAddressBlocks();
    });

    return block;
  }

  function renumberAddressBlocks() {
    const container = $('addresses');
    const blocks = Array.from(container.querySelectorAll('.addrBlock'));
    blocks.forEach((b, i) => {
      const h = b.querySelector('.addrHeader .title');
      if (h) h.textContent = 'Adrese ' + (i + 1);
    });
  }

  function addAddress() {
    const container = $('addresses');
    const idx = container.querySelectorAll('.addrBlock').length;
    const isFirst = idx === 0;
    container.appendChild(newAddressBlock(idx, isFirst));
  }

  $('addAddressBtn').addEventListener('click', () => addAddress());

  // initial one address
  addAddress();

  // ---------- window banner ----------
  async function refreshWindow() {
    try {
      const r = await fetch('/api/window', { headers: { 'Accept': 'application/json' } });
      const d = await r.json();
      windowInfo = d;

      if (d.enforce) {
        if (d.is_open || d.isOpen) {
          banner.className = 'banner info';
          banner.style.display = 'block';
          banner.textContent = 'Iesniegšana ir atvērta.';
        } else {
          banner.className = 'banner danger';
          banner.style.display = 'block';
          banner.textContent = 'Iesniegšana šobrīd nav atvērta.';
        }
      } else {
        banner.className = 'banner danger';
        banner.style.display = 'block';
        banner.textContent = 'TESTA vide: iesniegšana nav ierobežota pēc datuma.';
      }
    } catch (e) { /* ignore */ }
  }
  refreshWindow();

  // ---------- submit ----------
  function collectPayload() {
    const code = getSubscriberCode().replace(/\D/g, '');
    if (code.length !== 8) return { error: 'Abonenta kodam jābūt 8 cipariem.' };

    const addrBlocks = Array.from(document.querySelectorAll('.addrBlock'));
    if (!addrBlocks.length) return { error: 'Pievieno vismaz vienu adresi.' };

    const lines = [];
    for (const b of addrBlocks) {
      const addr = (b._addrInput.value || '').trim();
      if (!addr) return { error: 'Adrese nevar būt tukša.' };

      const rows = Array.from(b._metersHolder.querySelectorAll('.meterRow'));
      for (const r of rows) {
        const meterNo = (r._meterNo.value || '').trim();
        const reading = (r._reading.value || '').trim();
        if (!meterNo && !reading) continue; // allow empty extra rows
        if (!meterNo) return { error: 'Skaitītāja Nr nevar būt tukšs.' };
        if (!reading) return { error: 'Rādījums nevar būt tukšs.' };

        lines.push({
          adrese: addr,
          skaititaja_numurs: meterNo,
          radijums: reading
        });
      }
    }

    if (!lines.length) return { error: 'Ievadi vismaz vienu skaitītāju ar rādījumu.' };

    return {
      abonenta_numurs: code,
      client_submission_id: crypto.randomUUID(),
      website: $('website').value || '',
      lines
    };
  }

  $('submitBtn').addEventListener('click', async () => {
    clearMessage();

    if (windowInfo && windowInfo.enforce && !(windowInfo.is_open || windowInfo.isOpen)) {
      showMessage('Iesniegšana šobrīd nav atvērta.', false);
      return;
    }

    const payload = collectPayload();
    if (payload.error) return showMessage('Kļūda: ' + payload.error, false);

    try {
      const r = await fetch('/api/submit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
        body: JSON.stringify(payload),
      });
      const d = await r.json().catch(() => ({}));
      if (!r.ok || !d.ok) return showMessage('Kļūda: ' + (d.error || 'Neizdevās iesniegt.'), false);
      showMessage('Iesniegts veiksmīgi! Paldies.', true);
    } catch (e) {
      showMessage('Kļūda: Savienojuma problēma.', false);
    }
  });

})();
</script>
</body>
</html>
