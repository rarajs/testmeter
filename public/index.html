<!doctype html>
<html lang="lv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rādījumu iesniegšana</title>

  <style>
    :root{
      --bg:#f6f7f9;
      --card:#ffffff;
      --border:#d8dde3;
      --muted:#7b7b7b;
      --blue:#1f5f86;
      --danger:#b00020;
      --radius:14px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    *{ box-sizing:border-box; }
    body{ background:var(--bg); margin:0; padding:24px; color:#111; }
    .wrap{ max-width:980px; margin:0 auto; }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      padding:18px;
      box-shadow:0 6px 18px rgba(0,0,0,.06);
    }

    h1{ margin:0 0 14px; font-size:20px; font-weight:900; }
    .section-title{ font-size:14px; font-weight:900; margin:14px 0 8px; color:#1b1b1b; }

    .field{ display:flex; flex-direction:column; gap:6px; margin-bottom:12px; position:relative; }
    label{ font-size:13px; color:#222; font-weight:800; }

    input, button{ font:inherit; }
    input[type="text"]{
      border:2px solid #cfd6de;
      border-radius:var(--radius);
      padding:12px 12px;
      background:#fff;
      outline:none;
      transition:border-color .15s ease;
      width:100%;
    }
    input:focus{ border-color:var(--blue); }

    .error{ font-size:12px; color:var(--danger); display:none; }
    .error.show{ display:block; }

    /* Window notice */
    .noticeBox{
      margin:0 0 12px;
      border:1px solid #f0c9cf;
      background:#fff5f7;
      border-radius:14px;
      padding:10px 12px;
      font-size:13px;
      color:#7a0016;
      display:none;
    }
    .noticeBox.show{ display:block; }

    /* ===== Abonenta koda 8 kvadrātiņi ===== */
    /* Desktop: šauri kvadrātiņi kreisajā pusē */
    .code-boxes{
      display:flex;
      flex-wrap:nowrap;
      gap:8px;
      width:fit-content;   /* neizstiepj pa visu ekrānu */
      max-width:100%;
      overflow:hidden;
    }
    .code-boxes input{
      width:40px;
      height:46px;
      flex:0 0 40px;
      text-align:center;
      font-size:18px;
      font-weight:900;
      border-radius:12px;
      border:2px solid #cfd6de;
      padding:0;
      min-width:0;
    }

    /* Mobile: vienmēr 8 kolonnas iekš 100% platuma (neizlien ārā) */
    @media (max-width: 520px){
      .code-boxes{
        width:100%;
        display:grid;
        grid-template-columns: repeat(8, minmax(0, 1fr));
        gap:6px;
      }
      .code-boxes input{
        width:100%;
        flex:initial;
        height:44px;
        font-size:16px;
      }
    }
    @media (max-width: 380px){
      .code-boxes{ gap:5px; }
      .code-boxes input{ height:42px; font-size:15px; border-radius:10px; }
    }

    /* ===== Address blocks ===== */
    .address-block{
      border:2px solid #e3e7ec;
      border-radius:18px;
      padding:14px;
      margin-top:12px;
      background:#fff;
      position:relative;
    }

    .address-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
    }

    .badge{
      font-size:12px; color:#1b1b1b; font-weight:900;
      background:#eef3f8; border-radius:999px; padding:6px 10px;
    }
    .badge.hidden{ display:none; }

    .btn-row{ display:flex; gap:12px; margin-top:12px; flex-wrap:wrap; }
    .btn-secondary{
      border-radius:14px; border:2px solid #cfd6de; background:#fff;
      padding:12px 14px; cursor:pointer; font-weight:900;
    }

    .btn-add-meter{
      border-radius:12px;
      border:2px dashed #cfd6de;
      background:#f9fbfd;
      padding:10px 14px;
      font-weight:900;
      color:#1976d2;
      cursor:pointer;
      width:fit-content;
      margin-top:8px;
    }
    .btn-add-meter:hover{ background:#eef3f8; }

    .btn-primary{
      border-radius:14px; border:none; background:var(--blue); color:#fff;
      padding:14px 18px; cursor:pointer; font-weight:1000; width:100%; margin-top:14px;
    }
    .btn-primary.disabled{ opacity:.55; cursor:not-allowed; }

    /* Dzēst adresi poga — sarkana */
    .delete-address-btn{
      border-radius:14px;
      border:2px solid #f0c9cf;
      background:#fff;
      padding:10px 12px;
      cursor:pointer;
      font-weight:900;
      color:var(--danger);
      white-space:nowrap;
    }
    .delete-address-btn.hidden{ display:none; }
    .delete-address-btn:disabled{ opacity:.35; cursor:not-allowed; }

    /* ===== Meters ===== */
    .meters{ margin-top:10px; display:flex; flex-direction:column; gap:10px; }

    /* Desktop: 2 lauki + dzēst labajā pusē */
    .meter-row{
      display:grid;
      grid-template-columns: 1fr 1fr 56px;
      gap:10px;
      align-items:end;
    }
    .meterNrField{ grid-column:1; }
    .readingField{ grid-column:2; }
    .delCell{ grid-column:3; display:flex; justify-content:flex-end; align-items:flex-end; }

    /* Dzēst skaitītāju poga */
    .del-btn{
      width:42px;
      height:42px;
      border-radius:12px;
      border:2px solid #f0c9cf;
      background:#fff;
      color:var(--danger);
      cursor:pointer;
      font-weight:1000;
    }
    .del-btn.hidden{ display:none; }

    /* Mobile: Nr pilna rinda, Rādījums pilna rinda, Dzēst pilna rinda */
    @media (max-width:640px){
      .meter-row{
        grid-template-columns: 1fr;
        grid-template-rows: auto auto auto;
        align-items:stretch;
      }
      .meterNrField{ grid-column:auto; }
      .readingField{ grid-column:auto; }
      .delCell{ grid-column:auto; justify-content:stretch; }

      .del-btn{
        width:100%;
        height:auto;
        padding:12px 14px;
        border-radius:14px;
        text-align:center;
      }
      .del-btn span{ display:none; }
      .del-btn::before{ content:"Dzēst skaitītāju"; }

      /* Dzēst adresi mobilajā – pilna platuma, badge apakšā */
      .address-head{
        flex-direction:column;
        align-items:stretch;
        gap:8px;
      }
      .delete-address-btn{ width:100%; }
      .badge{ width:fit-content; }
    }

    /* Address autocomplete dropdown */
    .suggestions{
      position:absolute; top:100%; left:0; right:0;
      background:#fff; border:1px solid var(--border); border-radius:14px;
      box-shadow:0 10px 24px rgba(0,0,0,.12);
      overflow:hidden; z-index:50; margin-top:6px;
      display:none; max-height:320px; overflow-y:auto;
    }
    .suggestions.show{ display:block; }
    .sitem{
      width:100%;
      text-align:left;
      padding:10px 12px;
      background:#fff;
      border:none;
      cursor:pointer;
      font-size:13px;
      line-height:1.25;
    }
    .sitem:hover{ background:#eef3f8; }

    .infoBox{
      margin-top:10px;
      border:1px solid #f0c9cf;
      background:#fff5f7;
      border-radius:14px;
      padding:10px 12px;
      font-size:13px;
      color:#7a0016;
      display:none;
    }
    .infoBox.show{ display:block; }

    /* ===== Submit modal ===== */
    #submitModal { position: fixed; inset: 0; z-index: 9999; display:none; }
    #submitModalBackdrop { position: absolute; inset: 0; background: rgba(0,0,0,.35); }
    #submitModalCard{
      position:absolute;
      left:50%;
      top:50%;
      transform: translate(-50%,-50%);
      width:min(420px, calc(100vw - 32px));
      background:#fff;
      border:1px solid #e5e7eb;
      border-radius:16px;
      padding:16px 16px 14px;
      box-shadow: 0 18px 50px rgba(0,0,0,.18);
    }
    #submitModalTitle{
      font-weight: 900;
      font-size: 16px;
      margin: 0 0 6px;
    }
    #submitModalText{
      font-size: 14px;
      color:#333;
      margin: 0 0 12px;
    }
    #submitModalActions{
      display:flex;
      gap:10px;
      justify-content:flex-end;
    }
    #submitModalCloseBtn, #submitModalRetryBtn{
      border-radius: 12px;
      padding: 10px 12px;
      font-weight: 900;
      cursor: pointer;
      border: 2px solid #cfd6de;
      background: #fff;
    }
    #submitModalCloseBtn{
      border-color: var(--blue);
      color: var(--blue);
    }
    #submitModalRetryBtn{
      border-color: var(--danger);
      color: var(--danger);
    }
    @media (max-width:640px){
      #submitModalActions{ justify-content:stretch; }
      #submitModalCloseBtn, #submitModalRetryBtn{ width:100%; }
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <h1>Ūdens skaitītāju rādījumu iesniegšana</h1>

    <div id="windowNotice" class="noticeBox"></div>

    <div class="section-title">Abonenta informācija</div>
    <div class="field">
      <label>Abonenta numurs (8 cipari, sākas ar 012)</label>
      <div class="code-boxes" id="abonentaCodeBoxes"></div>
      <div class="error" id="errAbonents">Abonenta numuram jābūt 8 cipariem.</div>
    </div>

    <div class="section-title">Adreses un skaitītāji</div>
    <div id="addresses"></div>

    <div class="btn-row">
      <button class="btn-secondary" id="addAddressBtn" type="button">+ Pievienot adresi</button>
    </div>

    <button class="btn-primary disabled" id="submitBtn" type="button" aria-disabled="true">IESNIEGT</button>
    <div id="submitInfo" class="infoBox"></div>
  </div>
</div>

<!-- Submit popup (modal) -->
<div id="submitModal">
  <div id="submitModalBackdrop"></div>
  <div id="submitModalCard" role="dialog" aria-modal="true" aria-labelledby="submitModalTitle">
    <div id="submitModalTitle">SŪTU…</div>
    <div id="submitModalText">Lūdzu uzgaidi, notiek rādījumu nosūtīšana.</div>

    <div id="submitModalActions">
      <button type="button" id="submitModalCloseBtn" style="display:none;">AIZVĒRT</button>
      <button type="button" id="submitModalRetryBtn" style="display:none;">MĒĢINĀT VĒLREIZ</button>
    </div>
  </div>
</div>

<script>
  const CFG = {
    abonRegex: /^\\d{8}$/,
    meterNrRegex: /^\\d+$/,
    readingRegex: /^\\d+([.,]\\d{1,2})?$/,
    addrMinChars: 1,
    addrLimit: 12,
    // first meter row cannot be deleted
    meterDeleteShownFromIndex: 1
  };

  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  function el(tag, attrs={}, children=[]) {
    const n = document.createElement(tag);
    for (const [k, v] of Object.entries(attrs)) {
      if (k === "class") n.className = v;
      else if (k === "text") n.textContent = v;
      else if (k.startsWith("on") && typeof v === "function") n.addEventListener(k.slice(2), v);
      else n.setAttribute(k, v);
    }
    children.forEach(c => n.appendChild(typeof c === "string" ? document.createTextNode(c) : c));
    return n;
  }

  function escapeHtml(s) {
    return (s || "").replace(/[&<>"']/g, (c) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  // ===== Modal helpers =====
  function modalShow() { document.getElementById('submitModal').style.display = 'block'; }
  function modalHide() { document.getElementById('submitModal').style.display = 'none'; }

  function modalStateSending() {
    modalShow();
    document.getElementById('submitModalTitle').textContent = 'SŪTU…';
    document.getElementById('submitModalText').textContent = 'Lūdzu uzgaidi, notiek rādījumu nosūtīšana.';
    document.getElementById('submitModalCloseBtn').style.display = 'none';
    document.getElementById('submitModalRetryBtn').style.display = 'none';
  }

  function modalStateSuccess() {
    modalShow();
    document.getElementById('submitModalTitle').textContent = 'RĀDĪJUMS IESNIEGTS';
    document.getElementById('submitModalText').textContent = 'Paldies! Jūsu rādījumi ir saņemti.';
    document.getElementById('submitModalCloseBtn').style.display = 'inline-block';
    document.getElementById('submitModalRetryBtn').style.display = 'none';
  }

  function modalStateError(errText) {
    modalShow();
    document.getElementById('submitModalTitle').textContent = 'KĻŪDA';
    document.getElementById('submitModalText').textContent = errText || 'Neizdevās nosūtīt. Lūdzu, mēģini vēlreiz.';
    document.getElementById('submitModalCloseBtn').style.display = 'inline-block';
    document.getElementById('submitModalRetryBtn').style.display = 'inline-block';
  }

  // notīra visu formu (abonents + adreses + skaitītāji)
  function resetFormToEmpty() {
    // abonenta kods
    $$("#abonentaCodeBoxes input").forEach(inp => inp.value = "");

    // adreses/skaitītāji: atstājam 1 tukšu adresi ar 1 skaitītāju
    const host = document.getElementById("addresses");
    host.innerHTML = "";
    host.appendChild(createAddressBlock());
    renumberAddresses();

    // atjauno submit stāvokli
    refreshAll();

    // fokusē pirmo ciparu
    const first = document.querySelector("#abonentaCodeBoxes input");
    if (first) first.focus();
  }

  document.getElementById('submitModalCloseBtn').addEventListener('click', () => {
    modalHide();

    // Pēc veiksmīgas iesniegšanas forma jau ir tukša,
    // tāpēc poga paliks "disabled" līdz lietotājs ievadīs jaunus datus.
    const btn = document.getElementById('submitBtn');
    btn.classList.remove('disabled');
    btn.setAttribute('aria-disabled', 'false');
    refreshAll();
  });

  document.getElementById('submitModalRetryBtn').addEventListener('click', () => {
    modalHide();
    const btn = document.getElementById('submitBtn');
    btn.classList.remove('disabled');
    btn.setAttribute('aria-disabled', 'false');
    refreshAll();
  });

  async function refreshWindowNotice() {
    const box = document.getElementById("windowNotice");
    try {
      const res = await fetch("/api/window");
      const w = await res.json();

      if (!w.is_open && w.enforce) {
        box.innerHTML = "<b>Rādījumu iesniegšana no 25.datuma līdz mēneša beigām.</b>";
        box.classList.add("show");
      } else if (!w.enforce) {
        box.innerHTML = "<b>TESTA vide:</b> iesniegšana nav ierobežota pēc datuma.";
        box.classList.add("show");
      } else {
        box.classList.remove("show");
        box.innerHTML = "";
      }
    } catch {
      box.classList.remove("show");
      box.innerHTML = "";
    }
  }

  // 8-digit boxes
  function initCodeBoxes() {
    const host = $("#abonentaCodeBoxes");
    host.innerHTML = "";
    for (let i=0; i<8; i++) {
      const inp = el("input", { type:"text", inputmode:"numeric", maxlength:"1", "aria-label":`Cipars ${i+1}` });

      inp.addEventListener("input", () => {
        inp.value = inp.value.replace(/\\D/g, "").slice(0,1);
        if (inp.value && i < 7) host.children[i+1].focus();
        refreshAll();
      });

      inp.addEventListener("keydown", (e) => {
        if (e.key === "Backspace" && !inp.value && i > 0) host.children[i-1].focus();
      });

      inp.addEventListener("paste", (e) => {
        e.preventDefault();
        const text = (e.clipboardData || window.clipboardData).getData("text");
        const digits = (text || "").replace(/\\D/g, "").slice(0,8);
        for (let j=0; j<8; j++) host.children[j].value = digits[j] || "";
        (host.children[Math.min(digits.length,7)] || host.children[7]).focus();
        refreshAll();
      });

      host.appendChild(inp);
    }
  }

  function readAbonentaKods() {
    return $$("#abonentaCodeBoxes input").map(i => i.value.trim()).join("");
  }

  // Address autocomplete via API
  async function fetchAddressSuggestions(q) {
    const res = await fetch(`/api/addresses?q=${encodeURIComponent(q)}&limit=${CFG.addrLimit}`);
    if (!res.ok) return [];
    const data = await res.json();
    const arr = data.items || data.results || [];
    return Array.isArray(arr) ? arr : [];
  }

  function buildSuggestionsBox() {
    return el("div", { class:"suggestions" });
  }

  function showSuggestions(box, items, onPick) {
    box.innerHTML = "";
    for (const t of items) {
      const b = el("button", { type:"button", class:"sitem", text:t });
      b.addEventListener("click", () => onPick(t));
      box.appendChild(b);
    }
    box.classList.add("show");
  }

  function hideSuggestions(box) {
    box.classList.remove("show");
  }

  function attachAddressAutocomplete(inputEl) {
    const box = buildSuggestionsBox();
    inputEl.parentElement.appendChild(box);

    let t = null;
    const update = () => {
      const q = inputEl.value.trim();
      clearTimeout(t);
      if (q.length < CFG.addrMinChars) { hideSuggestions(box); return; }

      t = setTimeout(async () => {
        const items = await fetchAddressSuggestions(q);
        if (!items.length) { hideSuggestions(box); return; }
        showSuggestions(box, items, (picked) => {
          inputEl.value = picked;
          hideSuggestions(box);
          refreshAll();
        });
      }, 180);
    };

    inputEl.addEventListener("input", () => { update(); refreshAll(); });
    inputEl.addEventListener("focus", update);
    inputEl.addEventListener("keydown", (e) => { if (e.key === "Escape") hideSuggestions(box); });

    document.addEventListener("click", (e) => {
      if (!inputEl.parentElement.contains(e.target)) hideSuggestions(box);
    });
  }

  // normalize reading: allow decimal, comma->dot, max 2 decimals
  function normalizeReadingInput(raw) {
    let s = String(raw || '').trim().replace(',', '.');
    s = s.replace(/[^\d.]/g, '');
    const firstDot = s.indexOf('.');
    if (firstDot !== -1) {
      s = s.slice(0, firstDot + 1) + s.slice(firstDot + 1).replace(/\./g, '');
      const [a, b=''] = s.split('.');
      s = a + '.' + b.slice(0, 2);
    }
    return s;
  }

  function renumberAddresses() {
    const blocks = $$(".address-block", $("#addresses"));
    blocks.forEach((block, i) => {
      const badge = $(".badge", block);
      if (i === 0) { badge.classList.add("hidden"); }
      else { badge.classList.remove("hidden"); badge.textContent = `Adrese ${i+1}`; }

      // first address cannot be deleted
      const delBtn = $(".delete-address-btn", block);
      if (delBtn) {
        delBtn.classList.toggle("hidden", i === 0);
        delBtn.disabled = (i === 0);
      }
    });
  }

  function updateMeterDeleteButtons(addressBlock) {
    const rows = $$(".meter-row", addressBlock);
    rows.forEach((r, idx) => {
      const btn = $(".del-btn", r);
      if (!btn) return;
      btn.classList.toggle("hidden", idx < CFG.meterDeleteShownFromIndex);
    });
  }

  function createMeterRow(addressBlock) {
    const row = el("div", { class:"meter-row" });

    const nrInput = el("input", { type:"text", inputmode:"numeric", placeholder:"", "data-role":"meterNr" });
    nrInput.addEventListener("input", () => {
      nrInput.value = nrInput.value.replace(/\D/g, "");
      refreshAll();
    });

    const valInput = el("input", { type:"text", inputmode:"decimal", placeholder:"", "data-role":"reading" });
    valInput.addEventListener("input", () => {
      valInput.value = normalizeReadingInput(valInput.value);
      refreshAll();
    });

    const f1 = el("div", { class:"field meterNrField" }, [
      el("label", { text:"Skaitītāja Nr" }),
      nrInput
    ]);

    const f2 = el("div", { class:"field readingField" }, [
      el("label", { text:"Rādījums" }),
      valInput
    ]);

    const delBtn = el("button", {
      type:"button",
      class:"del-btn hidden",
      title:"Dzēst skaitītāju",
      onclick: () => {
        row.remove();
        updateMeterDeleteButtons(addressBlock);
        refreshAll();
      }
    }, [el("span", { text:"✕" })]);

    const delCell = el("div", { class:"delCell" }, [delBtn]);

    row.append(f1, f2, delCell);
    return row;
  }

  function createAddressBlock() {
    const block = el("div", { class:"address-block" });

    const badge = el("div", { class:"badge", text:"Adrese 1" });

    const removeAddressBtn = el("button", {
      type:"button",
      class:"delete-address-btn hidden",
      text:"Dzēst adresi",
      onclick: () => {
        const all = $$(".address-block", $("#addresses"));
        if (all.length <= 1) return;
        block.remove();
        renumberAddresses();
        refreshAll();
      }
    });

    const head = el("div", { class:"address-head" }, [badge, removeAddressBtn]);

    const addressInput = el("input", {
      type:"text",
      placeholder:"",
      "data-role":"addressText",
      autocomplete:"off"
    });

    const addressField = el("div", { class:"field" }, [
      el("label", { text:"Adrese" }),
      addressInput
    ]);

    const metersHost = el("div", { class:"meters" });
    metersHost.appendChild(createMeterRow(block));

    const addMeterBtn = el("button", {
      type:"button",
      class:"btn-add-meter",
      text:"+ Pievienot skaitītāju",
      onclick: () => {
        metersHost.appendChild(createMeterRow(block));
        updateMeterDeleteButtons(block);
        refreshAll();
      }
    });

    block.append(head, addressField, metersHost, addMeterBtn);

    attachAddressAutocomplete(addressInput);
    addressInput.addEventListener("input", refreshAll);

    updateMeterDeleteButtons(block);
    return block;
  }

  function initAddresses() {
    const host = $("#addresses");
    host.innerHTML = "";
    host.appendChild(createAddressBlock());
    renumberAddresses();
  }

  function buildLines() {
    const lines = [];
    const blocks = $$(".address-block", $("#addresses"));
    for (const block of blocks) {
      const adrese = ($("input[data-role='addressText']", block).value || "").trim();
      const meterRows = $$(".meter-row", block);

      for (const r of meterRows) {
        const meter = ($("input[data-role='meterNr']", r).value || "").trim();
        const readingRaw = ($("input[data-role='reading']", r).value || "").trim();
        lines.push({ adrese, skaititaja_numurs: meter, radijums_raw: readingRaw });
      }
    }
    return lines;
  }

  function getBlockingReasons() {
    const reasons = [];
    const abon = readAbonentaKods();

    if (!CFG.abonRegex.test(abon)) reasons.push("Abonenta numuram jābūt 8 cipariem.");

    const blocks = $$(".address-block", $("#addresses"));
    if (blocks.length < 1) reasons.push("Nav pievienota neviena adrese.");

    blocks.forEach((block, ai) => {
      const addr = ($("input[data-role='addressText']", block).value || "").trim();
      if (!addr) reasons.push(`Adrese ${ai+1}: nav ievadīta adrese.`);
    });

    const lines = buildLines().filter(x => x.adrese || x.skaititaja_numurs || x.radijums_raw);
    if (!lines.length) reasons.push("Nav ievadīts neviens skaitītājs.");

    lines.forEach((ln, idx) => {
      if (!ln.adrese) return;
      if (!CFG.meterNrRegex.test(ln.skaititaja_numurs)) reasons.push(`Skaitītājs ${idx+1}: Nr jābūt tikai cipariem.`);

      const rNorm = normalizeReadingInput(ln.radijums_raw);
      if (!CFG.readingRegex.test(rNorm)) reasons.push(`Skaitītājs ${idx+1}: rādījumam jābūt skaitlim (līdz 2 zīmēm aiz komata).`);
    });

    return reasons;
  }

  function updateSubmitState() {
    const reasons = getBlockingReasons();
    const ok = reasons.length === 0;

    const btn = $("#submitBtn");
    btn.classList.toggle("disabled", !ok);
    btn.setAttribute("aria-disabled", ok ? "false" : "true");

    if (ok) {
      $("#submitInfo").classList.remove("show");
      $("#submitInfo").innerHTML = "";
    }
  }

  function showSubmitBlockedInfo() {
    const reasons = getBlockingReasons();
    const box = $("#submitInfo");
    if (!reasons.length) { box.classList.remove("show"); box.innerHTML=""; return; }

    box.innerHTML =
      "<b>Kāpēc poga IESNIEGT ir neaktīva:</b><ul style='margin:8px 0 0 18px; padding:0;'>" +
      reasons.map(r => `<li>${escapeHtml(r)}</li>`).join("") +
      "</ul>";
    box.classList.add("show");
  }

  async function submit() {
    updateSubmitState();
    const btn = $("#submitBtn");

    if (btn.classList.contains("disabled")) { showSubmitBlockedInfo(); return; }

    // Disable immediately to prevent double clicks
    btn.classList.add("disabled");
    btn.setAttribute("aria-disabled", "true");

    // stable id per attempt
    const KEY = "client_submission_id_current";
    let cid = sessionStorage.getItem(KEY);
    if (!cid) {
      cid = crypto.randomUUID();
      sessionStorage.setItem(KEY, cid);
    }

    modalStateSending();

    const abon = readAbonentaKods();
    const lines = buildLines()
      .filter(x => x.adrese || x.skaititaja_numurs || x.radijums_raw)
      .map(ln => ({
        adrese: ln.adrese,
        skaititaja_numurs: ln.skaititaja_numurs,
        radijums: normalizeReadingInput(ln.radijums_raw)
      }));

    const payload = {
      abonenta_numurs: abon,
      lines,
      website: "",
      client_submission_id: cid
    };

    try {
      const res = await fetch("/api/submit", {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });

      let j = null;
      try { j = await res.json(); } catch { j = null; }

      if (!res.ok || !j || j.ok !== true) {
        const msg = (j && j.error) ? j.error : "Neizdevās nosūtīt. Lūdzu, mēģini vēlreiz.";
        modalStateError(msg);
        btn.classList.remove("disabled");
        btn.setAttribute("aria-disabled", "false");
        return;
      }

      // success
      sessionStorage.removeItem(KEY);

      // ✅ ŠEIT: notīram visu formu uzreiz
      resetFormToEmpty();

      modalStateSuccess();
      // poga paliek disabled līdz AIZVĒRT, bet forma ir tukša, tāpēc atkārtots submit prasa jaunu ievadi
    } catch (e) {
      modalStateError("Savienojuma problēma. Lūdzu, mēģini vēlreiz.");
      btn.classList.remove("disabled");
      btn.setAttribute("aria-disabled", "false");
    }
  }

  function refreshAll() { updateSubmitState(); }

  function init() {
    initCodeBoxes();
    initAddresses();

    $("#addAddressBtn").addEventListener("click", () => {
      $("#addresses").appendChild(createAddressBlock());
      renumberAddresses();
      refreshAll();
    });

    $("#submitBtn").addEventListener("click", () => {
      if ($("#submitBtn").classList.contains("disabled")) showSubmitBlockedInfo();
      else submit();
    });

    refreshWindowNotice();
    refreshAll();
  }

  init();
</script>
</body>
</html>
