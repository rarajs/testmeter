<!doctype html>
<html lang="lv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>testmeter – Rādījumu iesniegšana</title>

  <style>
    :root{
      --bg:#f6f7f9;
      --card:#ffffff;
      --border:#d8dde3;
      --muted:#6b7280;
      --blue:#1f5f86;
      --err:#b00020;
      --ok:#0f7a3b;

      --radius:16px;
      --radius2:20px;

      --pad2:20px;
      --shadow: 0 10px 26px rgba(0,0,0,.08);

      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    *{ box-sizing:border-box; }

    body{
      background:var(--bg);
      margin:0;
      color:#111;
      padding:
        max(10px, env(safe-area-inset-top))
        max(10px, env(safe-area-inset-right))
        max(14px, env(safe-area-inset-bottom))
        max(10px, env(safe-area-inset-left));
    }

    .wrap{
      max-width:980px;
      margin:0 auto;
      padding: 12px;
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius: var(--radius2);
      padding: var(--pad2);
      box-shadow: var(--shadow);
    }

    @media (max-width: 420px){
      .wrap{ padding: 8px; }
      .card{ padding: 16px; }
    }

    h1{
      margin:0 0 12px;
      font-size:20px;
      font-weight:1000;
      letter-spacing:.2px;
    }

    .section-title{
      font-size:13px;
      font-weight:900;
      margin:16px 0 10px;
      color:#1b1b1b;
      display:flex;
      align-items:center;
      gap:10px;
    }

    .section-title::after{
      content:"";
      height:1px;
      background: #e7ebf0;
      flex:1;
    }

    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-bottom:12px;
      position:relative;
    }

    label{
      font-size:13px;
      color:#222;
      font-weight:900;
    }

    input, button{ font:inherit; }

    /* iOS no-zoom */
    input[type="text"]{
      font-size:16px;
      border:2px solid #cfd6de;
      border-radius: var(--radius);
      padding:12px 12px;
      background:#fff;
      outline:none;
      transition:border-color .15s ease, box-shadow .15s ease;
      min-height:46px;
      width:100%;
    }
    input:focus{
      border-color:var(--blue);
      box-shadow: 0 0 0 4px rgba(31,95,134,.12);
    }

    .error{
      font-size:12px;
      color:var(--err);
      display:none;
      font-weight:700;
    }
    .error.show{ display:block; }

    /* Window notice */
    .noticeBox{
      margin:0 0 12px;
      border:1px solid #f0c9cf;
      background:#fff5f7;
      border-radius: var(--radius);
      padding:10px 12px;
      font-size:13px;
      color:#7a0016;
      display:none;
    }
    .noticeBox.show{ display:block; }

    /* Abonenta numurs: prefikss + viens lauks 5 cipariem */
    .abon-row{
      display:flex;
      align-items:stretch;
      gap:10px;
      width:100%;
    }

    .abon-prefix{
      flex:0 0 auto;
      min-width:86px;
      display:flex;
      align-items:center;
      justify-content:center;
      border:2px solid #d7dde5;
      background:#f1f3f6;
      color:#9aa3ad;
      border-radius: var(--radius);
      font-weight:1000;
      font-size:20px;
      letter-spacing:.6px;
      padding: 0 14px;
      min-height:54px;
      user-select:none;
    }

    .abon-input{
      flex:1 1 auto;
      min-height:54px;
      font-size:20px;
      text-align:left;
      letter-spacing:.6px;
    }

    @media (max-width: 420px){
      .abon-prefix{ min-width:76px; font-size:18px; min-height:50px; }
      .abon-input{ min-height:50px; font-size:18px; }
    }

    /* Address blocks */
    .address-block{
      border:1px solid #e5eaf0;
      border-radius: var(--radius2);
      padding: 14px;
      margin-top:12px;
      background:#fff;
    }
    .address-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .badge{
      font-size:12px;
      color:#1b1b1b;
      font-weight:1000;
      background:#eef3f8;
      border-radius:999px;
      padding:6px 10px;
    }
    .badge.hidden{ display:none; }

    /* Meters */
    .meters{
      margin-top:10px;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .meter-row{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      align-items:stretch;
      border:1px solid #eef2f6;
      border-radius: var(--radius);
      padding:12px;
      background:#fbfcfe;
    }

    .del-btn{
      width:100%;
      border-radius: 14px;
      border:2px solid #f0c9cf;
      background:#fff;
      color:#b00020;
      cursor:pointer;
      font-weight:1000;
      min-height:46px;
    }
    .del-btn.hidden{ display:none; }

    @media (min-width: 760px){
      .meter-row{
        grid-template-columns: 1fr 1fr auto;
        align-items:end;
        padding:14px;
      }
      .del-btn{
        width:46px;
        min-width:46px;
        min-height:46px;
        padding:0;
        border-radius:14px;
      }
    }

    .btn-row{
      display:flex;
      gap:12px;
      margin-top:12px;
      flex-wrap:wrap;
    }

    .btn-secondary{
      border-radius:14px;
      border:2px solid #cfd6de;
      background:#fff;
      padding:12px 14px;
      cursor:pointer;
      font-weight:1000;
      min-height:46px;
    }

    .btn-add-meter{
      border-radius:14px;
      border:2px dashed #cfd6de;
      background:#f9fbfd;
      padding:12px 14px;
      font-weight:1000;
      color:#1976d2;
      cursor:pointer;
      width:100%;
      margin-top:8px;
      min-height:46px;
    }
    @media (min-width: 520px){
      .btn-add-meter{ width: fit-content; }
    }
    .btn-add-meter:hover{ background:#eef3f8; }

    .sticky-submit{
      position: sticky;
      bottom: 0;
      padding: 12px 0 max(12px, env(safe-area-inset-bottom));
      background: rgba(246,247,249,.88);
      backdrop-filter: blur(10px);
      margin-top: 14px;
    }

    .btn-primary{
      border-radius: 16px;
      border:none;
      background: var(--blue);
      color:#fff;
      padding: 14px 18px;
      cursor:pointer;
      font-weight:1000;
      width:100%;
      min-height:52px;
      box-shadow: 0 10px 24px rgba(31,95,134,.18);
    }
    .btn-primary:active{ transform: translateY(1px); }
    .btn-primary.disabled{
      opacity:.55;
      cursor:not-allowed;
      box-shadow:none;
    }

    .suggestions{
      position:absolute;
      top:100%;
      left:0;
      right:0;
      background:#fff;
      border:1px solid var(--border);
      border-radius: 16px;
      box-shadow: 0 14px 28px rgba(0,0,0,.12);
      overflow:hidden;
      z-index:50;
      margin-top:8px;
      display:none;
      max-height:320px;
      overflow-y:auto;
    }
    .suggestions.show{ display:block; }

    .sitem{
      width:100%;
      text-align:left;
      padding:12px 12px;
      background:#fff;
      border:none;
      cursor:pointer;
      font-size:14px;
      line-height:1.25;
    }
    .sitem:hover{ background:#eef3f8; }

    .infoBox{
      margin-top:10px;
      border:1px solid #f0c9cf;
      background:#fff5f7;
      border-radius: var(--radius);
      padding:10px 12px;
      font-size:13px;
      color:#7a0016;
      display:none;
    }
    .infoBox.show{ display:block; }

    .infoOk{
      border:1px solid rgba(15,122,59,.25);
      background: rgba(15,122,59,.08);
      color: var(--ok);
    }

    .muted{ color: var(--muted); font-size:12px; font-weight:700; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1>Rādījumu iesniegšana (testmeter)</h1>

      <div id="windowNotice" class="noticeBox"></div>

      <div class="section-title">Abonenta informācija</div>

      <div class="field">
        <label>Abonenta numurs (8 cipari)</label>
        <div class="muted">Ievadi pēdējos 5 ciparus.</div>

        <div class="abon-row">
          <div class="abon-prefix" aria-hidden="true">012</div>
          <input
            id="abonTail"
            class="abon-input"
            type="text"
            inputmode="numeric"
            pattern="[0-9]*"
            maxlength="5"
            placeholder="_____"
            autocomplete="off"
            aria-label="Ievadi pēdējos 5 ciparus"
          />
        </div>

        <div class="error" id="errAbonents">Abonenta numuram jābūt 8 cipariem.</div>
      </div>

      <div class="section-title">Adreses un skaitītāji</div>
      <div id="addresses"></div>

      <div class="btn-row">
        <button class="btn-secondary" id="addAddressBtn" type="button">+ Pievienot adresi</button>
      </div>

      <div class="sticky-submit">
        <button class="btn-primary disabled" id="submitBtn" type="button" aria-disabled="true">IESNIEGT</button>
        <div id="submitInfo" class="infoBox"></div>
      </div>
    </div>
  </div>

<script>
  const CFG = {
    abonRegex: /^012\d{5}$/,
    meterNrRegex: /^\d+$/,
    readingRegex: /^\d+$/,
    addrMinChars: 2,
    addrLimit: 12,
    meterDeleteShownFromIndex: 1
  };

  const $ = (sel, root=document) => root.querySelector(sel);
  const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  function el(tag, attrs={}, children=[]) {
    const n = document.createElement(tag);
    for (const [k, v] of Object.entries(attrs)) {
      if (k === "class") n.className = v;
      else if (k === "text") n.textContent = v;
      else if (k.startsWith("on") && typeof v === "function") n.addEventListener(k.slice(2), v);
      else n.setAttribute(k, v);
    }
    children.forEach(c => n.appendChild(typeof c === "string" ? document.createTextNode(c) : c));
    return n;
  }

  function showError(id, show) { document.getElementById(id).classList.toggle("show", !!show); }
  function escapeHtml(s) {
    return (s || "").replace(/[&<>"']/g, (c) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  async function refreshWindowNotice() {
    const box = document.getElementById("windowNotice");
    try {
      const res = await fetch("/api/window");
      const w = await res.json();

      if (!w.is_open && w.enforce) {
        box.innerHTML = "<b>Rādījumus var iesniegt tikai no katra mēneša 25. datuma 00:00 līdz mēneša pēdējam datumam 23:59.</b>";
        box.classList.add("show");
      } else if (!w.enforce) {
        box.innerHTML = "<b>TESTA vide:</b> iesniegšana nav ierobežota pēc datuma.";
        box.classList.add("show");
      } else {
        box.classList.remove("show");
        box.innerHTML = "";
      }
    } catch {
      box.classList.remove("show");
      box.innerHTML = "";
    }
  }

  // Abonenta numurs: prefikss 012 + 5 cipari
  function initAbonentInput() {
    const inp = $("#abonTail");

    const normalize = () => {
      inp.value = (inp.value || "").replace(/\D/g, "").slice(0,5);
      refreshAll();

      // Bonus: kad ievadīti 5 cipari, pāriet uz pirmo adreses lauku
      if (inp.value.length === 5) {
        const firstAddr = $("#addresses input[data-role='addressText']");
        if (firstAddr) firstAddr.focus();
      }
    };

    inp.addEventListener("input", normalize);

    inp.addEventListener("paste", (e) => {
      e.preventDefault();
      const text = (e.clipboardData || window.clipboardData).getData("text") || "";
      const digits = text.replace(/\D/g, "");

      // atbalstām gan 012xxxxx, gan xxxxx
      let tail = "";
      if (digits.length >= 8) tail = digits.slice(-5);
      else tail = digits.slice(0,5);

      inp.value = tail;
      normalize();
    });
  }

  function readAbonentaKods() {
    const tail = ($("#abonTail").value || "").trim();
    return "012" + tail;
  }

  // Address autocomplete via API
  async function fetchAddressSuggestions(q) {
    const res = await fetch(`/api/addresses?q=${encodeURIComponent(q)}&limit=${CFG.addrLimit}`);
    if (!res.ok) return [];
    const data = await res.json();
    return Array.isArray(data.items) ? data.items : [];
  }

  function buildSuggestionsBox() {
    return el("div", { class:"suggestions" });
  }

  function showSuggestions(box, items, onPick) {
    box.innerHTML = "";
    for (const t of items) {
      const b = el("button", { type:"button", class:"sitem", text:t });
      b.addEventListener("click", () => onPick(t));
      box.appendChild(b);
    }
    box.classList.add("show");
  }

  function hideSuggestions(box) {
    box.classList.remove("show");
  }

  function attachAddressAutocomplete(inputEl) {
    const box = buildSuggestionsBox();
    inputEl.parentElement.appendChild(box);

    let t = null;
    const update = () => {
      const q = inputEl.value.trim();
      clearTimeout(t);
      if (q.length < CFG.addrMinChars) { hideSuggestions(box); return; }

      t = setTimeout(async () => {
        const items = await fetchAddressSuggestions(q);
        if (!items.length) { hideSuggestions(box); return; }
        showSuggestions(box, items, (picked) => {
          inputEl.value = picked;
          hideSuggestions(box);
          refreshAll();
        });
      }, 180);
    };

    inputEl.addEventListener("input", () => { update(); refreshAll(); });
    inputEl.addEventListener("focus", update);
    inputEl.addEventListener("keydown", (e) => { if (e.key === "Escape") hideSuggestions(box); });

    document.addEventListener("click", (e) => {
      if (!inputEl.parentElement.contains(e.target)) hideSuggestions(box);
    });
  }

  // Addresses + meters UI
  function renumberAddresses() {
    const blocks = $$(".address-block", $("#addresses"));
    blocks.forEach((block, i) => {
      const badge = $(".badge", block);
      if (i === 0) badge.classList.add("hidden");
      else { badge.classList.remove("hidden"); badge.textContent = `Adrese ${i+1}`; }

      const delBtn = $(".delete-address-btn", block);
      if (delBtn) delBtn.style.display = (i === 0) ? "none" : "inline-block";
    });
  }

  function updateMeterDeleteButtons(addressBlock) {
    const rows = $$(".meter-row", addressBlock);
    rows.forEach((r, idx) => {
      const btn = $(".del-btn", r);
      if (!btn) return;
      btn.classList.toggle("hidden", idx < CFG.meterDeleteShownFromIndex);
    });
  }

  function createMeterRow(addressBlock) {
    const row = el("div", { class:"meter-row" });

    const nrInput = el("input", {
      type:"text",
      inputmode:"numeric",
      pattern:"[0-9]*",
      placeholder:"",
      "data-role":"meterNr",
      autocomplete:"off"
    });
    nrInput.addEventListener("input", () => {
      nrInput.value = nrInput.value.replace(/\D/g, "");
      refreshAll();
    });

    const valInput = el("input", {
      type:"text",
      inputmode:"numeric",
      pattern:"[0-9]*",
      placeholder:"123",
      "data-role":"reading",
      autocomplete:"off"
    });
    valInput.addEventListener("input", () => {
      valInput.value = valInput.value.replace(/\D/g, "");
      refreshAll();
    });

    const f1 = el("div", { class:"field" }, [
      el("label", { text:"Skaitītāja Nr" }),
      nrInput,
      el("div", { class:"error", "data-err":"meterNr", text:"Skaitītāja Nr jābūt tikai cipariem." })
    ]);

    const f2 = el("div", { class:"field" }, [
      el("label", { text:"Rādījums" }),
      valInput,
      el("div", { class:"error", "data-err":"reading", text:"Rādījumam jābūt veselam skaitlim." })
    ]);

    const del = el("button", {
      type:"button",
      class:"del-btn hidden",
      title:"Dzēst skaitītāju",
      text:"Dzēst skaitītāju",
      onclick: () => {
        row.remove();
        updateMeterDeleteButtons(addressBlock);
        refreshAll();
      }
    });

    row.append(f1, f2, del);
    return row;
  }

  function createAddressBlock() {
    const block = el("div", { class:"address-block" });

    const head = el("div", { class:"address-head" }, [
      el("div", { class:"badge", text:"Adrese 1" })
    ]);

    const addressInput = el("input", {
      type:"text",
      placeholder:"Ievadiet adresi",
      "data-role":"addressText",
      autocomplete:"street-address"
    });

    const addressField = el("div", { class:"field" }, [
      el("label", { text:"Adrese" }),
      addressInput,
      el("div", { class:"error", "data-err":"addressText", text:"Ievadiet adresi." })
    ]);

    const metersHost = el("div", { class:"meters" });
    metersHost.appendChild(createMeterRow(block));

    const addMeterBtn = el("button", {
      type:"button",
      class:"btn-add-meter",
      text:"+ Pievienot skaitītāju",
      onclick: () => {
        metersHost.appendChild(createMeterRow(block));
        updateMeterDeleteButtons(block);
        refreshAll();
      }
    });

    const removeAddressBtn = el("button", {
      type:"button",
      class:"btn-secondary delete-address-btn",
      text:"Dzēst adresi",
      onclick: () => {
        const all = $$(".address-block", $("#addresses"));
        if (all.length <= 1) return;
        block.remove();
        renumberAddresses();
        refreshAll();
      }
    });

    const actions = el("div", { class:"btn-row" }, [removeAddressBtn]);

    block.append(head, addressField, metersHost, addMeterBtn, actions);

    attachAddressAutocomplete(addressInput);
    addressInput.addEventListener("input", refreshAll);

    updateMeterDeleteButtons(block);
    return block;
  }

  function initAddresses() {
    const host = $("#addresses");
    host.innerHTML = "";
    host.appendChild(createAddressBlock());
    renumberAddresses();
  }

  function buildLines() {
    const lines = [];
    const blocks = $$(".address-block", $("#addresses"));

    for (const block of blocks) {
      const adrese = ($("input[data-role='addressText']", block).value || "").trim();
      const meterRows = $$(".meter-row", block);

      for (const r of meterRows) {
        const meter = ($("input[data-role='meterNr']", r).value || "").trim();
        const readingRaw = ($("input[data-role='reading']", r).value || "").trim();
        lines.push({ adrese, skaititaja_numurs: meter, radijums_raw: readingRaw, rowEl: r });
      }
    }
    return lines;
  }

  function getBlockingReasons() {
    const reasons = [];
    const abon = readAbonentaKods();

    if (!CFG.abonRegex.test(abon)) reasons.push("Abonenta numuram jābūt 8 cipariem.");

    const blocks = $$(".address-block", $("#addresses"));
    if (blocks.length < 1) reasons.push("Nav pievienota neviena adrese.");

    const lines = buildLines();
    if (lines.length < 1) reasons.push("Nav pievienots neviens skaitītājs.");

    blocks.forEach((block, ai) => {
      const addr = ($("input[data-role='addressText']", block).value || "").trim();
      if (!addr) reasons.push(`Adrese ${ai+1}: nav ievadīta adrese.`);
    });

    lines.forEach((ln, idx) => {
      if (!ln.adrese) return;
      if (!CFG.meterNrRegex.test(ln.skaititaja_numurs)) reasons.push(`Skaitītājs ${idx+1}: Nr jābūt tikai cipariem.`);
      if (!CFG.readingRegex.test(ln.radijums_raw)) reasons.push(`Skaitītājs ${idx+1}: rādījumam jābūt veselam skaitlim.`);
    });

    return reasons;
  }

  function updateSubmitState() {
    const reasons = getBlockingReasons();
    const ok = reasons.length === 0;

    const btn = $("#submitBtn");
    btn.classList.toggle("disabled", !ok);
    btn.setAttribute("aria-disabled", ok ? "false" : "true");

    if (ok) {
      $("#submitInfo").classList.remove("show", "infoOk");
      $("#submitInfo").innerHTML = "";
    }
  }

  function showSubmitBlockedInfo() {
    const reasons = getBlockingReasons();
    const box = $("#submitInfo");
    if (!reasons.length) { box.classList.remove("show","infoOk"); box.innerHTML=""; return; }

    box.innerHTML =
      "<b>Kāpēc poga IESNIEGT ir neaktīva:</b><ul style='margin:8px 0 0 18px; padding:0;'>" +
      reasons.map(r => `<li>${escapeHtml(r)}</li>`).join("") +
      "</ul>";
    box.classList.add("show");
    box.classList.remove("infoOk");
  }

  function showOk(msg){
    const box = $("#submitInfo");
    box.innerHTML = "<b>Gatavs!</b> " + escapeHtml(msg);
    box.classList.add("show","infoOk");
  }

  function refreshFieldErrors() {
    const abon = readAbonentaKods();
    showError("errAbonents", ($("#abonTail").value || "").trim().length > 0 && !CFG.abonRegex.test(abon));

    const blocks = $$(".address-block", $("#addresses"));
    blocks.forEach(block => {
      const addrInp = $("input[data-role='addressText']", block);
      const addrErr = $("[data-err='addressText']", block);
      addrErr.classList.toggle("show", (addrInp.value || "").trim() === "");
    });

    const lines = buildLines();
    lines.forEach(ln => {
      const nrErr = $("[data-err='meterNr']", ln.rowEl);
      const rdErr = $("[data-err='reading']", ln.rowEl);
      nrErr.classList.toggle("show", !CFG.meterNrRegex.test(ln.skaititaja_numurs));
      rdErr.classList.toggle("show", !CFG.readingRegex.test(ln.radijums_raw));
    });
  }

  async function submit() {
    refreshFieldErrors();
    updateSubmitState();

    if ($("#submitBtn").classList.contains("disabled")) {
      showSubmitBlockedInfo();
      return;
    }

    const abon = readAbonentaKods();
    const lines = buildLines().map(ln => ({
      adrese: ln.adrese,
      skaititaja_numurs: ln.skaititaja_numurs,
      radijums: Number(ln.radijums_raw)
    }));

    const payload = { abonenta_numurs: abon, lines };

    const res = await fetch("/api/submit", {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });

    if (!res.ok) {
      let msg = "";
      try {
        const j = await res.json();
        msg = j?.error || "";
      } catch {
        msg = await res.text();
      }
      $("#submitInfo").innerHTML = "<b>Kļūda:</b> " + escapeHtml(msg || "Neizdevās iesniegt.");
      $("#submitInfo").classList.add("show");
      $("#submitInfo").classList.remove("infoOk");
      return;
    }

    // notīra tikai rādījumus
    $$(".meter-row input[data-role='reading']").forEach(inp => inp.value = "");
    refreshAll();
    showOk("Rādījumi iesniegti.");
  }

  function refreshAll() { updateSubmitState(); }

  function init() {
    initAbonentInput();
    initAddresses();

    $("#addAddressBtn").addEventListener("click", () => {
      $("#addresses").appendChild(createAddressBlock());
      renumberAddresses();
      refreshAll();
    });

    $("#submitBtn").addEventListener("click", () => {
      if ($("#submitBtn").classList.contains("disabled")) showSubmitBlockedInfo();
      else submit();
    });

    refreshWindowNotice();
    refreshAll();
  }

  init();
</script>
</body>
</html>
